rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Users collection - Allow authenticated users to read and manage their own profile
    // Allow public creation for customer accounts (Telegram users accessing via shop links)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if (isAuthenticated() && request.auth.uid == userId) ||
                      (request.resource.data.role == 'customer' &&
                       request.resource.data.telegramId is number &&
                       request.resource.data.displayName is string);
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }

    // Shops collection - Public read, authenticated users can create/update their own shops
    match /shops/{shopId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();

      // Shop statistics subcollection
      match /stats/{statId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }

    // Categories collection - Public read, authenticated users can manage
    match /categories/{categoryId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Departments collection - Authenticated users can manage
    match /departments/{departmentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Products collection - Public read, authenticated users can manage
    match /products/{productId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Orders collection - Authenticated users can manage
    match /orders/{orderId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Customers collection - Authenticated users can manage
    match /customers/{customerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Shop Customers collection - Allow unauthenticated creation for customer registration via shop links
    match /shop_customers/{shopCustomerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() ||
                      (request.resource.data.role == 'customer' &&
                       request.resource.data.telegramId is number &&
                       request.resource.data.shopId is string);
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Shop Owners collection - Authenticated users can manage their own data
    match /shop_owners/{ownerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // CRM Contacts collection - Authenticated users can manage
    match /crm_contacts/{contactId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // CRM Tags collection - Authenticated users can manage
    match /crm_tags/{tagId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // CRM Message Templates collection - Authenticated users can manage
    match /crm_message_templates/{templateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // CRM Auto Tag Rules collection - Authenticated users can manage
    match /crm_auto_tag_rules/{ruleId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Shop Links collection - Public read, authenticated users can manage
    match /shop_links/{linkId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Promotions collection - Public read, authenticated users can manage
    match /promotions/{promotionId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Analytics collection - Authenticated users can manage
    match /analytics/{analyticsId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // System configuration - Authenticated users can access
    match /system/{configId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Allow public read for all documents by default, authenticated write
    match /{document=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
  }
}
